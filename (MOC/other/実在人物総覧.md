---
aliases:
---
#moc #char/historical 
>[!warning]
実在人物には脚色が多く含まれています。
また「詳しくはwikipediaを見ろ」というスタンスです。
詳しくは[[実在記事のガイドライン]]を見てください。

```dataviewjs
/***** 設定 *****/
// 必ず末尾にスラッシュ（"org/gov/" のように）
const TAG_PREFIX = "char/historical";

// 親タグそのもの（"org/gov"）をバケツとして出したいなら true
const INCLUDE_PARENT_BUCKET = true;

// 1ノートが複数の該当タグを持っていても、最も深い（文字数が長い）タグにだけ入れる
const LEAF_ONLY = true;

// 表の並び順: "name" | "ctime" | "mtime" | "chars"
const SORT_BY = "name";
const SORT_DIR = "asc";

/***** ユーティリティ *****/
const norm = t => t.replace(/^#/, "").replace(/\/+$/,""); // 末尾スラッシュ除去
const prefixNoSlash = TAG_PREFIX.replace(/\/+$/,"");       // "org/gov"
const prefixWithSlash = prefixNoSlash + "/";               // "org/gov/"

/***** 収集 *****/
let pages = dv.pages()
  .where(p => p.file.ext === "md")
  .where(p => p.file.path !== dv.current().file.path);

/***** 本文を読み、対象タグ抽出＋文字数算出 *****/
const metas = [];
for (const p of pages) {
  const tags = (p.file.tags ?? []).map(norm);

  // 該当するタグ（親 or 子）を抽出
  const hits = [];
  for (const t of tags) {
    if (t === prefixNoSlash) {
      if (INCLUDE_PARENT_BUCKET) hits.push(t);            // 親を含める場合のみ
    } else if (t.startsWith(prefixWithSlash)) {
      hits.push(t);
    }
  }
  if (hits.length === 0) continue;

  // LEAF_ONLYなら最も長いタグだけを残す（= 一番具体的なカテゴリ）
  const useTags = LEAF_ONLY ? [hits.sort((a,b)=>b.length-a.length)[0]] : hits;

  // 本文読み込みで文字数
  let text = "";
  try { text = await dv.io.load(p.file.path) ?? ""; } catch {}
  metas.push({
    page: p,
    chars: text.length,
    c: p.file.ctime,
    m: p.file.mtime,
    tags: useTags
  });
}

/***** 並び替え設定 *****/
const cmp = {
  name : (a,b)=> a.page.file.name.localeCompare(b.page.file.name),
  ctime: (a,b)=> a.c - b.c,
  mtime: (a,b)=> a.m - b.m,
  chars: (a,b)=> a.chars - b.chars
}[SORT_BY] ?? ((a,b)=>0);

/***** グルーピング（サブカテゴリ名＝ prefix の後ろ） *****/
const groups = new Map();
for (const meta of metas) {
  // 複数タグをそれぞれのグループへ（LEAF_ONLYなら1個）
  for (const t of meta.tags) {
    const key = (t === prefixNoSlash)
      ? prefixNoSlash                      // 親そのもの（表示したいときだけ）
      : t.slice(prefixWithSlash.length);   // 例: "fbi"
    if (!groups.has(key)) groups.set(key, []);
    groups.get(key).push(meta);
  }
}

/***** 出力 *****/
const headers = ["タイトル", "文字数", "作成日", "更新日"];
let totalChars = 0, totalCount = 0, maxItem = null;

// グループ名ソート（アルファベット）
for (const key of [...groups.keys()].sort((a,b)=>a.localeCompare(b))) {
  const keyLabel = (key === prefixNoSlash) 
    ? `${prefixNoSlash} (root)`               // org/gov のとき
    : `${prefixWithSlash}${key}`;             // org/gov/fbi のとき
  dv.header(2, keyLabel);   // 例: org/gov/fbi

  const arr = groups.get(key).slice().sort(cmp);
  if (SORT_DIR === "desc") arr.reverse();

  const rows = arr.map(meta => {
    totalChars += meta.chars;
    totalCount += 1;
    if (!maxItem || meta.chars > maxItem.chars) maxItem = meta;
    return [
      meta.page.file.link,
      meta.chars.toLocaleString(),
      meta.c.toFormat("yyyy-MM-dd"),
      meta.m.toFormat("yyyy-MM-dd"),
    ];
  });
  dv.table(headers, rows);
}

/***** フッター統計 *****/
if (totalCount) {
  const avg = Math.round(totalChars / totalCount);
  dv.paragraph(
    `最大：**${maxItem.page.file.link}**（${maxItem.chars.toLocaleString()} 文字） / ` +
    `平均：約${avg.toLocaleString()} 文字 / 合計：${totalChars.toLocaleString()} 文字`
  );
} else {
  dv.paragraph(`（${TAG_PREFIX} に該当するノートがありません）`);
}

```
